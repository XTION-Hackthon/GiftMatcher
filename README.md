# 接口文档

- **接口地址**: `http://<服务器IP>:8000/match`
- **请求方式**: `POST`
- **数据格式**: `application/json`

## 请求参数示例

前端需要把所有参与者的信息打包成一个数组发送过来。
**注意**：`gift_description` 直接传用户填写的长文本，`quiz_data` 传题目和选项的完整文字。

```json
[
  {
    "id": "user_01",
    "name": "钢铁侠",
    "email": "tony@stark.com",
    "wechat": "iron_man",
    "mbti": "ENTP",
    "gift_description": "我做了一个方舟反应堆模型，会发蓝光，虽然不能发电但摆在桌上非常赛博朋克。",
    "quiz_data": [
      {
        "question_text": "出门参加圣诞派对，你会选择哪条围巾搭配？",
        "selected_option": "D. 黑色机能风防风面罩围脖"
      },
      {
        "question_text": "周末一般怎么过？",
        "selected_option": "B. 在实验室搞科研"
      }
    ]
  },
  {
    "id": "user_02",
    "name": "美队",
    "email": "steve@usa.com",
    "wechat": "cap_america",
    "mbti": "ISFJ",
    "gift_description": "一本二战时期的素描本复刻版，包含一套专业绘画铅笔。",
    "quiz_data": [
      {
        "question_text": "出门参加圣诞派对，你会选择哪条围巾搭配？",
        "selected_option": "A. 纯灰色的羊绒围巾"
      },
      {
        "question_text": "周末一般怎么过？",
        "selected_option": "C. 去看画展"
      }
    ]
  }
]
```

## 返回结果示例

后端会返回一个排好序的链表 (`chain`)，前端按顺序展示即可。
`match_reason` 是 AI 结合性格和礼物生成的推荐理由。

```json
{
  "chain": [
    {
      "giver_name": "钢铁侠",
      "giver_wechat": "iron_man",
      "receiver_name": "美队",
      "receiver_wechat": "cap_america",
      "gift_summary": "方舟反应堆模型",
      "match_reason": "虽然美队喜好复古，但AI分析认为该模型具有极高的收藏价值..."
    },
    {
      "giver_name": "美队",
      "giver_wechat": "cap_america",
      "receiver_name": "钢铁侠",
      "receiver_wechat": "iron_man",
      "gift_summary": "素描本复刻版",
      "match_reason": "托尼其实内心细腻，素描本能帮助他记录灵感..."
    }
  ],
  "total_participants": 2
}
```

---

## 环境依赖

请确保安装 Python 3.8+，并安装以下库：

```bash
pip install fastapi uvicorn openai pydantic python-dotenv
```

## 启动服务

在根目录下运行：

```bash
python run.py
```

启动后：

- 接口地址: `http://localhost:8000/match`
- 在线文档: `http://localhost:8000/docs`

---

# 技术流程详解

> 利用 **大语言模型** 进行非结构化数据的特征提取与情感计算，结合 **自适应混合模因算法 (Memetic Algorithm)** 解决带约束的组合优化问题，最终输出全局满意度最优的环形赠送链条。

## 1. 数据预处理与上下文构建

**挑战**：用户输入包含大量的非结构化文本（如几百字的礼物描述）和离散的标签数据（MBTI、问卷选项）。
**处理逻辑**：

- **格式化**：将分散的问卷选项拼接为语义连贯的字符串（如 `问:周末安排 -> 答:独自在家`）。
- **提示词构建**：构建结构化提示词，定义 AI 的角色（心理分析师）和任务边界（提取特征、计算匹配分）。

## 2. AI 语义推理与特征量化

这是系统的核心智能化环节。我们不依赖传统的关键词匹配，而是进行深层的**意图识别**。

- **输入**：
  - **人物画像**：性格特征 + 行为偏好。
  - **物品画像**：自然语言描述的物品。
- **推理过程**：
  1.  **实体抽取**：从冗长的描述中提取核心物品（如 `“一个粉色毛绒玩具”`）。
  2.  **偏好映射**：分析人物的潜在需求（如 `INTJ + 独处` $\rightarrow$ 偏好 `实用/科技/阅读类`）。
  3.  **相容性计算**：评估物品对该人物的吸引力，输出 $0-100$ 的量化分数。
- **输出**：一个二维矩阵，记录了任意两人之间礼物赠送的满意度分数。

> **示例数据结构 (评分矩阵)**：
>
> ```json
> [
>   { "receiver": "A", "giver": "B", "score": 85, "reason": "符合极简审美..." },
>   { "receiver": "A", "giver": "C", "score": 30, "reason": "风格过于花哨..." }
> ]
> ```

## 3. 组合优化求解

**数学问题**：在一个包含所有人的关系图中，寻找一条**路径**，使得路径的总权重（满意度总和）最大。

- **约束条件 1**：所有人都必须在路径上（保证每人都有礼物）。
- **约束条件 2**：路径必须首尾相连形成一个大环（防止出现多个孤立的小圈子）。

**算法选型：自适应混合模因算法 (Adaptive Memetic Algorithm)**
鉴于单纯遗传算法收敛慢、局部搜索易陷死胡同的问题，我们设计了一种“全局探索 + 局部改良”的混合架构。

- **核心步骤**：
  1.  **混合初始化**：种群初始化采用“50% 随机 + 50% 贪婪策略”，在保证多样性的同时提高起跑线。
  2.  **全局搜索 (繁衍)**：通过锦标赛选择和 PMX 交叉算子，让优秀的基因片段（高满意度的局部匹配链）在种群中遗传。
  3.  **局部改良 (教育)**：这是算法加速的关键。对每一个新生成的子代，立即执行 **快速局部搜索 (2-Opt)**。这相当于让每个“孩子”在出生后都接受特训，迅速达到局部最优。
  4.  **精英保留**：始终保留历史最优个体，确保迭代过程中解的质量只升不降，最终收敛至全局近似最优解。

---

# 数据流转示例

为了更直观地理解，我们追踪一组数据在系统中的形态变化。

### 阶段 1: 原始输入

```json
// 用户 A 的输入
{
  "mbti": "ENTP",
  "gift_desc": "我做了一个微型反应堆模型，会发蓝光...",
  "quiz": ["喜欢赛博朋克", "爱折腾"]
}
```

### 阶段 2: AI 推理结果

系统内部生成的中间态数据：

- **特征提取**：`礼物特征 = ["科技感", "装饰品", "漫威周边", "发光"]`
- **需求侧写**：`用户A需求 = ["新奇", "独特", "非传统"]`
- **匹配计算**：当 AI 分析 **用户 B (送羊绒围巾)** vs **用户 A** 时：
  - _判定_：围巾过于传统实用，不符合 ENTP 的猎奇心理。
  - _打分_：`分数: 40`

### 阶段 3: 最终链表

前端接收到的最终 JSON：

```json
[
  {
    "giver": "用户 C (送乐高)",
    "receiver": "用户 A (ENTP)",
    "match_reason": "乐高的拼搭属性完美契合 ENTP 爱折腾的性格...",
    "gift_summary": "限定款乐高积木"
  },
  ...
]
```

---

## 鲁棒性与边界处理

为了保证系统在实际生产环境中的稳定性，我们设计了以下容错机制：

1.  **自送自收屏蔽**：在矩阵构建阶段，强制将自己对自己的匹配权重设为 0，从数学上杜绝自己抽到自己礼物的情况。
2.  **停滞逃逸机制**：如果在进化过程中连续多代最优解未提升，算法会自动引入新的随机个体（鲶鱼效应），激活种群活力。
3.  **算法兜底**：在极低概率下（如 AI 服务完全不可用），系统会降级为纯随机匹配模式，确保活动流程不中断。
